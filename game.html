<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Virus Fighter</title>
</head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.5.6/pixi.js"></script>
<script src="tink.js"></script>
<script src="helpers.js"></script>
<body>
<script type="text/javascript">

    //Aliases
    var Container = PIXI.Container,
        autoDetectRenderer = PIXI.autoDetectRenderer,
        loader = PIXI.loader,
        resources = PIXI.loader.resources,
        TextureCache = PIXI.utils.TextureCache,
        Texture = PIXI.Texture,
        Sprite = PIXI.Sprite,
        Text = PIXI.Text,
        Graphics = PIXI.Graphics;

    var width = 1080;
    var height = 1920;
    var sizing = 0.25;

    //Create a Pixi stage and renderer and add the
    //renderer.view to the DOM
    var stage = new Container(),
        renderer = autoDetectRenderer(width * sizing, height * sizing);


    document.body.appendChild(renderer.view);

    loader
        .add("images/bars_anim.json")
        .add("images/draggable_divide.png")
        .add("images/draggable_equals.png")
        .add("images/draggable_minus.png")
        .add("images/draggable_multiply.png")
        .add("images/draggable_num.png")
        .add("images/draggable_plus.png")
        .add("images/window_draggables.png")
        .add("images/phone_back_main.png")
        //.add("images/treasureHunter.json")
        .load(setup);

    //Define variables that might be used in more
    //than one function
    var state, comboZone, comboArea, answer, goButton, minisZone, time, ticker,
        restartButton, healthBar, message, gameScene, gameOverScene, enemies, id;

    function setup() {                                                                                                                                                      [378/4306]
        ticker = -1;
        //Make the game scene and add it to the stage
        gameScene = new Container();
        stage.addChild(gameScene);

        //Make the sprites and add them to the `gameScene`
        //Create an alias for the texture atlas frame ids
        id = resources["images/bars_anim.json"].textures;

        // Create top battery bar
        var topBar = new Container();
        var battery = new Graphics();
        battery.beginFill("0x15BC31");
        battery.lineStyle(4, "0xFFFFFF", 1);
        battery.drawRect(0, 0, 100, 20);
        battery.endFill();
        battery.position.set(168, 0);
        topBar.addChild(battery);
        time = new Text("", { fontFamily: "Arial", fontSize: 10, fill: "white"});
        time.position.set(5, 5);
        topBar.addChild(time);
        gameScene.addChild(topBar);

        // Create Minis zone
        minisZone = new Container();
        var minisFrame = new Graphics();
        minisFrame.beginFill("0xFFFFFF");
        minisFrame.lineStyle(4, "0x000000", 1);
        minisFrame.drawRect(0, 0, width * sizing, height * sizing * 0.2);
        minisFrame.endFill();
        minisZone.position.set(0, 24);
        minisZone.addChild(minisFrame);
        gameScene.addChild(minisZone);

        // Create Prompt zone
        var promptZone = new Container();
        var promptFrame = new Graphics();
        promptFrame.beginFill("0xFFFFFF");
        promptFrame.lineStyle(4, "0x000000", 1);
        promptFrame.drawRect(0, 0, width * sizing, height * sizing * 0.2);
        promptFrame.endFill();
        promptZone.addChild(promptFrame);
        answer = randomInt(1, 50);
        var answerText = new Text(answer.toString(),
            { fontFamily: "Arial", fontSize: 40, fill: "black"});
        answerText.x = width * sizing * 0.4;
        answerText.y = 20;
        promptZone.addChild(answerText);
        promptZone.position.set(0, 120);
        gameScene.addChild(promptZone);

        // Create Combo zone
        comboZone = new Container();
        var comboFrame = new Graphics();
        comboFrame.beginFill("0xFFFFFF");
        comboFrame.lineStyle(4, "0x000000", 1);
        comboFrame.drawRect(0, 0, width * sizing * .8, height * sizing * 0.1);
        comboFrame.endFill();
        comboZone.addChild(comboFrame);
        comboZone.position.set(0, 230);
        comboArea = new Text("",
            { fontFamily: "Arial", fontSize: 20, fill: "black" });
        comboArea.mathSeq = [];
        comboArea.position.set(5, 13);
        comboZone.addChild(comboArea);
        gameScene.addChild(comboZone);

        // Setup Go Button (check combo.)
        goButton = new Graphics();
        goButton.beginFill("0xFFFFFF");
        goButton.lineStyle(4, "0x000000", 1);
        goButton.drawRect(0, 0, width * sizing * .2, comboZone.height);
        goButton.endFill();
        goButton.moveTo(0, 0);
        goButton.lineTo(goButton.width, goButton.height);
        goButton.moveTo(0, goButton.height);
        goButton.lineTo(goButton.width, 0);
        comboZone.addChild(goButton);
        goButton.x = comboZone.width - 4;
        goButton.interactive = true;
        goButton.clicked = false;
        goButton.on('click', function(evt) { goButton.clicked = true; });

        // Create Options zone
        var optionsZone = new Container();
        var optionsImg = new Sprite(resources["images/window_draggables.png"].texture);
        optionsImg.width = width * sizing;
        optionsImg.height = height * sizing * 0.42;
        optionsZone.addChild(optionsImg);
//        var optionsFrame = new Graphics();
//        optionsFrame.beginFill("0xFFFFFF");
//        optionsFrame.lineStyle(4, "0x000000", 1);
//        optionsFrame.drawRect(0, 0, width * sizing, height * sizing * 0.4);
//        optionsFrame.endFill();
//        optionsZone.addChild(optionsFrame);
        optionsZone.position.set(0, 280);
        gameScene.addChild(optionsZone);

        var numbers = createNumbers();
        var operators = createOperators();

        // Init draggable functionality on buttons.
        makeDraggable(numbers);
        makeDraggable(operators);

        var leftOffset = 35;
        var vertOffset = 40;
        var buttonSize = 47;
        var padding = 20;
        // Add number buttons.
        for (var i = 0; i < 8; i++) {
            optionsZone.addChild(numbers[i]);
            var x, y;
            if (i < 4) {
                x = leftOffset + i * (buttonSize + padding);
                y = vertOffset;

            } else {
                x = leftOffset + (i - 4) * (buttonSize + padding);
                y = vertOffset + buttonSize + padding;
            }
            numbers[i].position.set(x, y);
            numbers[i].origPosition = {x: x, y: y };
        }
        // Add operator buttons.
        for (var i = 0; i < 4; i++) {
            optionsZone.addChild(operators[i]);
            var x = leftOffset + i * (buttonSize + padding);
            var y = vertOffset + 2 * (buttonSize + padding) - 10;
            operators[i].position.set(x, y);
            operators[i].origPosition = {x: x, y: y };
        }

        //Create the `gameOver` scene
        gameOverScene = new Container();
        stage.addChild(gameOverScene);

        //Make the `gameOver` scene invisible when the game first starts
        gameOverScene.visible = false;

        //Create the text sprite and add it to the `gameOver` scene
        message = new Text(
            "A winner...\n is you!",
            {fontFamily: "Futura", fontSize: 30, fill: "white", align: "center"}
        );
        message.x = stage.width / 4;
        message.y = stage.height / 2 - 32;
        gameOverScene.addChild(message);

        restartButton = new Graphics();
        restartButton.clicked = false;
        restartButton.interactive = true;
        restartButton.on('click', function(evt) { restartButton.clicked = true });
        restartButton.beginFill("0xFFFFFF");
        restartButton.lineStyle(1, "0xFFFFFF", 1);
        restartButton.drawRect(0, 0, 150, 50);
        restartButton.endFill();
        restartButton.position.set(75, 300);
        restartButton.addChild(new Text("Play again"));//, { fontFamily: "Arial", fontSize: 20, fill: "black", align: "center"}));
        gameOverScene.addChild(restartButton);
        //Set the game state
        state = play;

        //Start the game loop
        gameLoop();
    }

    function gameLoop(){
        requestAnimationFrame(gameLoop);
        state();
        renderer.render(stage);
    }

    function play() {
        ticker++;
        if (ticker % 60 === 0) {
            updateTime();
        }
        if (goButton.clicked && comboArea.mathSeq.length % 2 === 1) {
            var result = checkResult()
            if (result === answer) {
                state = done;
            } else {
                var text = new Text("MATH ERROR!!!  " + result.toString());
                text.x = 20;
                text.y = minisZone.y;
                minisZone.addChild(text);
                goButton.clicked = false;
            }
        } else {
            goButton.clicked = false;
        }
    }

    function done() {
        gameScene.visible = false;
        gameOverScene.visible = true;
        if (restartButton.clicked) {
            gameOverScene.visible = false;
            setup();
        }
    }



</script>
</body>
</html>

