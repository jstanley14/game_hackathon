<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Malware Math</title>
</head>
<script src="pixi.js"></script>
<script src="tink.js"></script>
<script src="helpers.js"></script>
<script src="config.js"></script>
<body>
<script type="text/javascript">

    //Aliases
    let Container = PIXI.Container,
        autoDetectRenderer = PIXI.autoDetectRenderer,
        loader = PIXI.loader,
        resources = PIXI.loader.resources,
        TextureCache = PIXI.utils.TextureCache,
        Texture = PIXI.Texture,
        Sprite = PIXI.Sprite,
        Text = PIXI.Text,
        Graphics = PIXI.Graphics;

    let width = 1080;
    let height = 1920;
    let sizing = 1;

    //Create a Pixi stage and renderer and add the
    //renderer.view to the DOM
    let stage = new Container(),
        renderer = autoDetectRenderer(width * sizing, height * sizing);


    document.body.appendChild(renderer.view);

    loader
        .add("images/bars_anim.json")
        .add("images/draggable_divide.png")
        .add("images/draggable_equals.png")
        .add("images/draggable_minus.png")
        .add("images/draggable_multiply.png")
        .add("images/draggable_num.png")
        .add("images/draggable_plus.png")
        .add("images/window_draggables.png")
        .add("images/phone_back_main.png")
        .add("images/icon_alert.png")
        .add("images/window_drop_zone.png")
        .add("images/window_alert.png")
        .add("images/window_virus_area.png")
        .add("images/progress_number.png")
        .add("images/temp_virus_guy01.png")
        .add("images/temp_virus_guy_mini.png")
        .add("images/battery_state01.png")
        .add("images/battery_state02.png")
        .add("images/battery_state03.png")
        .add("images/battery_state04.png")
        .add("images/battery_state05.png")
        .add("images/battery_state06.png")
        .add("images/battery_state07.png")
        .add("images/target_number_box.png")
        .add("images/outline_mockup.png")
        .add("images/window_combo.png")
        .load(setup);

    //Define variables that might be used in more
    //than one function
    let state, comboZone, comboArea, answer, eqButton, minisZone, time, ticker,
        restartButton, resultText, message, gameScene, gameOverScene, promptText,
        progressNumber, id, minisText;

    let batteryNum = 1;

    let questions = config.questions;
    let numQuestions = questions.length;
    let curQuestion = 0;

    function setup() {
        ticker = -1;
        //Make the game scene and add it to the stage
        gameScene = new Container();
        stage.addChild(gameScene);

        //Make the sprites and add them to the `gameScene`
        //Create an alias for the texture atlas frame ids
        id = resources["images/bars_anim.json"].textures;

        // Create background
        let background = new Sprite(resources["images/phone_back_main.png"].texture);
        background.width = width * sizing;
        background.height = height * sizing;
        gameScene.addChild(background);

        // Create top battery bar
        let topBar = new Container();
        let frames = [];
        for (let i = 0; i < 493; i++) {
            let val = "";
            if (i < 10) {
                val = "00" + i.toString();
            } else if (i < 100) {
                val = "0" + i.toString();
            } else {
                val = i.toString();
            }
            frames.push(Texture.fromFrame("bars0" + val))
        }
        let anim = new PIXI.extras.AnimatedSprite(frames);
        topBar.addChild(anim);
        anim.width = 100 * sizing;
        anim.height = 80 * sizing;
        anim.x = width * sizing * 0.67;
        anim.y = 20 * sizing;
        anim.animationSpeed = 0.5;
        anim.play();

        let battery = new Sprite(resources["images/battery_state0" + batteryNum.toString() + ".png"].texture);
        battery.width = 180 * sizing;
        battery.height = 80 * sizing;
        topBar.addChild(battery);
        battery.x = width * sizing * 0.8;
        battery.y = 20 * sizing;
        time = new Text("",
            { fontFamily: "Arial", fontSize: 50 * sizing , fill: "white", fontWeight: "lighter"});
        time.position.set(30 * sizing, 30 * sizing);
        topBar.addChild(time);
        gameScene.addChild(topBar);


        // Create Minis zone
        minisZone = new Container();
        minisZone.y = topBar.height + 70 * sizing;
        let minisImg = new Sprite(resources["images/window_virus_area.png"].texture);
        minisImg.width = width * sizing;
        minisImg.height = height * sizing * 0.31;
        minisZone.addChild(minisImg);
        //let progressImage = new Sprite(resources["images/progress_number.png"].texture);
        //progressImage.height = progressImage.width = 50;
//        progressNumber = new Text((numQuestions - curQuestion).toString(),
//            { fontFamily: "Arial", fontSize: 25, fill: "white"});
        //minisZone.addChild(progressImage);
//        progressImage.position.set(width * sizing * 0.8, -5);
//        minisZone.addChild(progressNumber);
//        progressNumber.position.set(width * sizing * 0.865, 4);
        minisText = new Text("Virus Analysis",
            { fontFamily: "Arial", fontSize: 65 * sizing, fill: "black"});
        minisZone.addChild(minisText);
        minisText.position.set(325 * sizing, 36 * sizing);
        gameScene.addChild(minisZone);

        // Add viruses
        let curVirus = new Sprite(resources["images/temp_virus_guy01.png"].texture);
        curVirus.width = 310 * sizing;
        curVirus.height = 290 * sizing;
        let curVirusName = "";
        if (!!questions[curQuestion].virusName) {
            curVirusName = questions[curQuestion].virusName
        } else {
            curVirusName = randomName();
        }
        let curVirusText = new Text(curVirusName,
            { fontFamily: "Arial", fontSize: 56, fill: "white" });
        minisZone.addChild(curVirus);
        curVirus.position.set(95 * sizing, 130 * sizing);
        minisZone.addChild(curVirusText);
        curVirusText.position.set(85 * sizing, 485 * sizing);

        // Layout bottom row first, right to left.
        for (let i = 0; i < numQuestions - curQuestion - 1; i++) {
            let virus = new Sprite(resources["images/temp_virus_guy_mini.png"].texture);
            virus.width = 130 * sizing;
            virus.height = 115 * sizing;
            minisZone.addChild(virus);
            let curLine = Math.floor(i / 4);
            let curPos = i % 4;
            virus.x = minisZone.width - 190 * sizing - virus.width * curPos;
            virus.y = 300 - 120 * sizing - (virus.height * (curLine - 1));
        }


        // Create Prompt zone
        let promptZone = new Container();
        let promptImg = new Sprite(resources["images/window_combo.png"].texture);
        promptImg.width = width * sizing;
        promptImg.height = 500 * sizing;
        promptZone.addChild(promptImg);
        if (questions[curQuestion].answer !== undefined) {
            answer = questions[curQuestion].answer;
        } else {
            answer = randomInt(1, 50);
        }
        let alertImg = new Sprite(resources["images/icon_alert.png"].texture);
        alertImg.width = alertImg.height = 140 * sizing;
        promptZone.addChild(alertImg);
        alertImg.position.set(35 * sizing, 60 * sizing);

        let prompt = "";
        if (!!questions[curQuestion].prompt) {
            prompt = questions[curQuestion].prompt;
        } else {
            prompt = randomPrompt();
        }
        promptText = new Text(prompt, { fontFamily: "Arial", fontSize: 50 * sizing });
        promptZone.addChild(promptText);
        promptText.position.set(200 * sizing, 80 * sizing);

        let answerBox = new Container();
        let answerBoxImg = new Sprite(resources["images/target_number_box.png"].texture);
        answerBoxImg.width = answerBox.height = 200 * sizing;
        answerBox.addChild(answerBoxImg);
        promptZone.addChild(answerBox);
        answerBox.position.set((promptZone.width - 230) * sizing, 25 * sizing);


        let answerText = new Text(answer.toString(),
            { fontFamily: "Arial", fontSize: 100, fill: "black"});
        answerBox.addChild(answerText);
        answerText.anchor.set(-0.3);
        gameScene.addChild(promptZone);
        promptZone.position.set(0, minisZone.y + minisZone.height - 7);

        // Create Combo zone
        comboZone = new Container();
        let comboRect = new Graphics();
        //comboRect.lineStyle(1, 0x99CCFF, 1);
        //comboRect.beginFill(0xFF9933);
        comboRect.drawRoundedRect(0, 0, 588, 188, 40); // one on right is 188x188
        //comboRect.endFill();
        comboZone.addChild(comboRect);
        comboRect.x = 45 * sizing;
        comboArea = new Text("",
            { fontFamily: "Arial", fontSize: 140, fill: "black" });
        comboArea.mathSeq = [];
        comboZone.addChild(comboArea);
        comboArea.position.set(25 * sizing, 13 * sizing);
        gameScene.addChild(comboZone);
        comboZone.y = promptZone.y + promptZone.height - comboZone.height - 40 * sizing;

        // Setup Equals button (check result.)
        eqButton = new Sprite(resources["images/draggable_equals.png"].texture);
        eqButton.width = eqButton.height = 210 * sizing;
        eqButton.interactive = true;
        eqButton.clicked = false;
        eqButton.on('click', function(evt) { eqButton.clicked = true; });
        comboZone.addChild(eqButton);
        eqButton.x = comboRect.x + comboRect.width + 5 * sizing;
        eqButton.y = -10 * sizing;

        // Create Result zone (shows student result);
        let resultZone = new Container();
        resultText = new Text("?",
            { fontFamily: "Arial", fontSize: 140 * sizing, fill: "black "});
        resultText.anchor.set(0.3);
        resultZone.addChild(resultText);
        resultText.position.set(width * sizing * 0.87, 60 * sizing);
        comboZone.addChild(resultZone);

        // Create Options zone
        let optionsZone = new Container();
        let optionsImg = new Sprite(resources["images/window_draggables.png"].texture);
        optionsImg.width = width * sizing;
        optionsImg.height = height * sizing * 0.35;
        optionsZone.addChild(optionsImg);
        optionsZone.position.set(0, comboZone.y + comboZone.height + 20 * sizing);
        gameScene.addChild(optionsZone);

        let numbers = createNumbers(questions[curQuestion].choices);
        let operators = createOperators(questions[curQuestion].ops);

        // Init draggable functionality on buttons.
        makeDraggable(numbers);
        makeDraggable(operators);

        let numbersPane = new Container();
        optionsZone.addChild(numbersPane);
        numbersPane.y = 5 * sizing;
        let leftOffset = 140 * sizing;
        let vertOffset = 120 * sizing;
        // 3x3 grid, max 9 buttons (w/o weirdness.)
        for (let i = 0; i < numbers.length; i++) {
            let curLine = Math.floor(i / 3);
            let curPos = i % 3;
            numbersPane.addChild(numbers[i]);
            numbers[i].x = leftOffset + curPos * numbers[i].width - (10 * sizing * curPos);
            numbers[i].y = vertOffset + curLine * numbers[i].height - (6 * sizing * curLine);
            numbers[i].origPosition = {x: numbers[i].x, y: numbers[i].y }
        }

        let opsPane = new Container();
        optionsZone.addChild(opsPane);
        opsPane.y = 5 * sizing;
        opsPane.x = numbersPane.width + numbersPane.x - 10 * sizing;
        // Default 4, max 6.
        for (let i = 0; i < operators.length; i++) {
            let curLine = Math.floor(i / 2);
            let curPos = i % 2;
            opsPane.addChild(operators[i]);
            operators[i].x = leftOffset + curPos * operators[i].width - (5 * curPos);
            operators[i].y = vertOffset + curLine * operators[i].height; //+ (5 * curLine);
            operators[i].origPosition = {x: operators[i].x, y: operators[i].y };
        }

        let wireframe = new Sprite(resources["images/outline_mockup.png"].texture);
        //gameScene.addChild(wireframe);

        //Create the `gameOver` scene
        gameOverScene = new Container();
        stage.addChild(gameOverScene);

        //Make the `gameOver` scene invisible when the game first starts
        gameOverScene.visible = false;

        //Create the text sprite and add it to the `gameOver` scene
        message = new Text(
            "A winner...\n is you!",
            {fontFamily: "Futura", fontSize: 30, fill: "white", align: "center"}
        );
        message.x = stage.width / 4;
        message.y = stage.height / 2 - 32;
        gameOverScene.addChild(message);

        restartButton = new Graphics();
        restartButton.clicked = false;
        restartButton.interactive = true;
        restartButton.on('click', function(evt) { restartButton.clicked = true });
        restartButton.beginFill("0xFFFFFF");
        restartButton.lineStyle(1, "0xFFFFFF", 1);
        restartButton.drawRect(0, 0, 150, 50);
        restartButton.endFill();
        restartButton.position.set(75, 300);
        restartButton.addChild(new Text("Play again"));
        gameOverScene.addChild(restartButton);
        //Set the game state
        state = play;

        //Start the game loop
        gameLoop();
    }

    function gameLoop(){
        requestAnimationFrame(gameLoop);
        state();
        renderer.render(stage);
    }

    function play() {
        // Battery gone?
        if (batteryNum > 6) {
            message.text = "Battery drained!\nTry again?";
            state = done;
        }
        // Answered all questions?
        if (curQuestion === numQuestions) {
            message.text = "A winner...\nis you!";
            state = done;
        }


        ticker++;
        if (ticker % 60 === 0) {
            updateTime();
        }
        if (eqButton.clicked && comboArea.mathSeq.length % 2 === 1) {
            let result = checkResult();
            resultText.text = result.toString();
            if (result === answer) {
                resultText.style = { fontFamily: "Arial", fontSize: 140 * sizing, fill: "green"};
                eqButton.clicked = false;
                promptText.text = "Great job!";
            } else {
                resultText.style =  { fontFamily: "Arial", fontSize: 140 * sizing, fill: "red "};
                eqButton.clicked = false;
                promptText.text = "The virus spreads!";
                // decrease battery bar
                batteryNum++;
                minisText.text = "Battery impacted!"
            }
            // wait a second and load next question
            window.setTimeout(function() {
                curQuestion++;
                gameScene.visible = false;
                setup();
            }, 2000)
        } else {
            eqButton.clicked = false;
        }
    }

    function done() {
        gameScene.visible = false;
        gameOverScene.visible = true;
        if (restartButton.clicked) {
            gameOverScene.visible = false;
            curQuestion = 0;
            batteryNum = 1;
            setup();
        }
    }



</script>
</body>
</html>

